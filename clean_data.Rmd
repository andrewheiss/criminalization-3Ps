---
title: "Data cleaning"
date: "`r format(Sys.time(), '%F')`"
---

```{r load-libraries, message=FALSE}
knitr::opts_chunk$set(fig.retina = 2,
                      tidy.opts=list(width.cutoff = 100),  # For code
                      options(width = 100))  # For output

library(tidyverse)
library(readxl)
library(stringr)
library(lubridate)
library(countrycode)
library(WDI)
library(rvest)
```

## Collect data

### 3P Trafficking Index

[Cho et al.'s 3P Trafficking Index](http://www.economics-human-trafficking.org/data-and-reports.html) uses World Bank codes which don't always perfectly correspond with ISO3 or COW codes. We ignore some countries and make manual changes for others. 

We fix these:

- BHU (Bhutan): 760 / BTN / BT
- KSV (Kosovo): 347 / XKK / XK
- RMI (Marshall Islands): 983 / MHL / MH
- HKG (Hong Kong): 715
- SRB (Serbia): 340

We ignore these:

- BES (Caribbean Netherlands): no cowcode / no ISO
- ABW (Aruba): no cowcode
- ANT (Netherlands Antilles): no cowcode
- CUW (Curacao): no cowcode
- MAC (Macao): no cowcode

```{r load-3p, message=FALSE}
cho.raw <- read_excel("data/Cho 3Ps/3P_Index_2000-2015.xlsx", skip = 2)

countries.to.ignore <- c("ABW", "ANT", "BES", "CUW", "MAC")
wb2iso2 <- c(BES = NA, BHU = "BT", KSV = "XK", RMI = "MH")
wb2iso3 <- c(BES = NA, BHU = "BTN", KSV = "XKK", RMI = "MHL")
wb2cow <- c(BHU = 760L, HKG = 715L, KSV = 347L, RMI = 983L, SRB = 340L)
wb_ignore <- c(ABW = NA, AIA = NA, ANT = NA, ASM = NA, BES = NA, BMU = NA, 
               COK = NA, CUW = NA, CYM = NA, GRL = NA, GUF = NA, GUM = NA, 
               JEY = NA, MAC = NA, MTQ = NA, NCL = NA, NIU = NA, PRI = NA, 
               REU = NA, VIR = NA, WBG = NA)
countryname2cow <- c(`European Union` = NA, Serbia = 340L)
iso22cow <- c(HK = 715L, RS = 340L, XK = 347L)

cho.clean <- cho.raw %>%
  mutate(iso2 = countrycode(Code, "wb", "iso2c", custom_match = wb2iso2),
         iso3 = countrycode(Code, "wb", "iso3c", custom_match = wb2iso3),
         cowcode = countrycode(Code, "wb", "cown", 
                               custom_match = c(wb2cow, wb_ignore))) %>%
  filter(!(Code %in% countries.to.ignore)) %>%
  select(year = Year, iso2, iso3, cowcode, 
         prosecution = Prosecution, protection = Protection,
         prevention = Prevention, p = `Overall 3P`) %>%
  mutate(year = as.integer(year), cowcode = as.integer(cowcode))

empty.panel <- cho.clean %>%
  expand(cowcode, year)

cho.panel <- empty.panel %>%
  left_join(cho.clean, by = c("cowcode", "year"))

cho.clean %>% glimpse()
```


### Control of corruption

We use control of corruption from the World Bank's Worldwide Governance Indicators data. [The official(?) website](http://info.worldbank.org/governance/wgi/) only offers WGI data as a horrific Excel file, but the [WGI's pseudo-page at the World Bank](http://data.worldbank.org/data-catalog/worldwide-governance-indicators) provides a link to a CSV(!).

There are more countries in the WGI data than in the 3P data. We ignore these:

- AIA = Anguilla
- ASM = American Samoa
- BMU = Bermuda
- COK = Cook Islands
- CYM = Cayman Islands
- GRL = Greenland
- GUF = French Guiana
- GUM = Guam
- JEY = Jersey, Channel Islands
- MTQ = Martinique
- NCL = New Caledonia
- NIU = Niue
- PRI = Puerto Rico
- REU = Réunion
- VIR = Virgin Islands
- WBG = West Bank and Gaza

```{r load-corruption, message=FALSE, warning=FALSE}
wgi.raw <- read_csv("data/WGI/WGI_Data.csv")

corruption <- wgi.raw %>% 
  filter(`Indicator Code` == "CC.EST") %>%
  mutate(cowcode = countrycode(`Country Code`, "wb", "cown", 
                               custom_match = c(wb2cow, wb_ignore))) %>%
  filter(!is.na(cowcode)) %>%
  select(cowcode, matches("\\d{4}")) %>%
  gather(year, corruption, -cowcode) %>%
  mutate(year = as.integer(year), cowcode = as.integer(cowcode)) %>%
  filter(year >= 2000)

corruption %>% glimpse()
```


### Democracy

We use democracy data from [Polity IV](http://www.systemicpeace.org/inscrdata.html).

```{r load-polity, message=FALSE}
polity.raw <- read_excel("data/Polity/p4v2015.xls")

polity <- polity.raw %>%
  select(cowcode = ccode, year, polity = polity2) %>%
  mutate(year = as.integer(year), cowcode = as.integer(cowcode)) %>%
  filter(year >= 2000)

polity %>% glimpse()
```


### Women legislators

We use data on the percent of women legislators from the [World Bank's Gender Statistics database](http://data.worldbank.org/data-catalog/gender-statistics).

Dozens of countries don't correspond to COW codes here, mostly becuase the data includes observations for regions like the Arab World (ARB) and Fragile and conflict affected situations (FCS). Rather than explicitly define every code to ignore, we just implicitly ignore unmatched codes.

I'm super curious to know what the original authors did with this data, too. 72% is missing!

```{r load-wb-gender, message=FALSE, warning=FALSE, cache=TRUE}
gender.raw <- read_csv("data/WB gender stats/Gender_Stat_Data.csv") 

gender <- gender.raw %>%
  filter(`Indicator Code` == "SG.GEN.LSOM.ZS") %>%
  mutate(cowcode = countrycode(`Country Code`, "wb", "cown", 
                               custom_match = c(wb2cow, wb_ignore))) %>%
  filter(!is.na(cowcode)) %>%
  select(cowcode, matches("\\d{4}")) %>%
  gather(year, female.leg.prop, -cowcode) %>%
  mutate(year = as.integer(year), cowcode = as.integer(cowcode)) %>%
  filter(year >= 2000)

gender %>% glimpse()
```


### Women's economic rights

We use data on women's economic rights from [CIRI](http://www.humanrightsdata.com/).

```{r load-ciri, message=FALSE}
ciri.raw <- read_csv("data/CIRI/CIRI Data 1981_2011 2014.04.14.csv",
                     na = c("-999", "-77", "-66")) 

wecon <- ciri.raw %>%
  select(cowcode = COW, year = YEAR, wecon = WECON) %>%
  filter(year >= 2000)

wecon %>% glimpse()
```


### International regime membership

We use [data from from the UN's treaty database](https://web.archive.org/web/20160403063433/https://treaties.un.org/Pages/ViewDetails.aspx?src=TREATY&mtdsg_no=XVIII-12-a&chapter=18&lang=en) on Palermo Protocol ratifications.

```{r load-palermo}
treaty.url <- "https://web.archive.org/web/20160403063433/https://treaties.un.org/Pages/ViewDetails.aspx?src=TREATY&mtdsg_no=XVIII-12-a&chapter=18&lang=en"

treaty.file <- file.path("data/Palermo protocol/ratifications.html")

if (!file.exists(treaty.file)) {
  download.file(treaty.url, "data/Palermo protocol/ratifications.html")
}

ratifications.raw <- read_html(treaty.file)

ratifications <- ratifications.raw %>%
  html_nodes(xpath='//*[@id="ctl00_ContentPlaceHolder1_tblgrid"]') %>%
  html_table(header=TRUE) %>% bind_rows() %>%
  magrittr::set_colnames(c("participant", "signature", "ratification")) %>%
  mutate(cowcode = countrycode(participant, "country.name", "cown",
                               custom_match = countryname2cow)) %>%
  mutate_at(vars(signature, ratification), 
            funs(str_extract(str_replace(., "\\t", " "),
                             "\\d{1,2}\\s+\\w{3}\\s+\\d{4}"))) %>%
  mutate_at(vars(signature, ratification),
            funs(date = dmy(.))) %>%
  mutate_at(vars(signature_date, ratification_date),
            funs(year = year(.))) %>%
  filter(!is.na(cowcode))

ratifications.panel <- ratifications %>%
  select(cowcode, contains("_year")) %>%
  right_join(empty.panel, by = "cowcode") %>%
  mutate_at(vars(contains("_year")),
            funs(bin = year >= .)) %>%
  mutate_at(vars(contains("bin")),
            funs(ifelse(is.na(.), FALSE, .))) %>%
  mutate(year = as.integer(year), cowcode = as.integer(cowcode)) %>%
  select(cowcode, year, palermo.signed = signature_date_year_bin,
         palermo.ratified = ratification_date_year_bin)

ratifications.panel %>% glimpse()
```


### GDP per capita

We use GDP per capita data (constant 2010 USD) from the [World Bank](http://data.worldbank.org/).

```{r load-wdi, cache=TRUE}
wdi.indicators <- c("NY.GDP.PCAP.KD",  # GDP per capita (constant 2010 USD)
                    "NY.GDP.MKTP.CD",  # GDP (current dollars)
                    "NY.GDP.MKTP.KD",  # GDP (constant 2010 USD)
                    "SP.POP.TOTL")     # Population, total

# Get all countries and regions because the World Bank chokes on ISO codes like
# XK for Kosovo, even though it returns data for Kosovo with the XK code
# ¯\_(ツ)_/¯
wdi.raw <- WDI(country="all", wdi.indicators,
               extra=FALSE, start=2000, end=2015)

# Filter countries here instead
wdi <- wdi.raw %>%
  filter(iso2c %in% unique(cho.clean$iso2)) %>%
  arrange(iso2c, year) %>%
  mutate(cowcode = countrycode(iso2c, "iso2c", "cown",
                               custom_match = iso22cow),
         year = as.integer(year)) %>%
  select(cowcode, year, 
         gdp.capita.2010 = NY.GDP.PCAP.KD, gdp.2010 = NY.GDP.MKTP.KD, 
         gdp.current = NY.GDP.MKTP.CD, population = SP.POP.TOTL)

wdi %>% glimpse()
```


### US aid

We use data from… somewhere… to measure US aid as a percent of GDP.

```{r load-us-aid}

```


## Combine data
